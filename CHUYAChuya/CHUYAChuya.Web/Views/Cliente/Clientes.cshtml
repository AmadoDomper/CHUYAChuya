@{
    Layout = null;
}
<div class="col-lg-11 col-lg-offset-0-5">
    <h3 class="text-center">CLIENTES</h3>
    <input id="hdnEstado" type="hidden" name="PersNat.oPers.nPersId" />
    <input id="hdnPag" type="hidden" />
    <div id="target1" class="panel move panel-inverse active" style="display: block;">
        <div class="panel-heading"><span class="glyphicon glyphicon-th" aria-hidden="true"></span> Lista de Clientes</div>
        <div class="panel-body">
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    @if (FrontUser.TienePermiso(RolesPermisos.Clie_Crear_Nuevo_Cliente))
                    {
                        <input href="#target2" id="btnNuevoCliente" type="button" class="btn btn-sm btn-success target" value="Nuevo Cliente" />
                    }
                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="row m-b-10 m-t-10">
                <div class="col-sm-11">
                    <div class="form-inline">
                        <div class="form-group m-r-10">
                            <label class="control-label m-r-5" for="product_name">Buscar por:</label>
                            <select name="status" id="cmbTpoBsq" class="form-control">
                                <option value="1" selected="">Codigo</option>
                                <option value="2">Nombre</option>
                                <option value="3">DOI</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" id="txtValor" class="form-control">
                        </div>
                        <input id="btnBuscarCli" type="button" value="Buscar" class="btn btn-sm btn-primary">
                    </div>
                </div>
            </div>
            <div class="row table-main">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div id="cntListaClientes" class="table-responsive">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="col-lg-5 col-lg-offset-4">
    <div id="target2" class="panel move panel-inverse" data-sortable-id="form-stuff-1" style="display: none;">
        <div class="panel-heading">
            <h4 class="panel-title">Nuevo Cliente</h4>
        </div>
        <div class="panel-body" style="display: block;">
            <div id="btnCliente" class="btn-group btn-group-justified m-b-10 m-t-5" role="group">
                <a hre="#frmClienteNat" data-val="0" class="btn btn-default btn-primary" role="button">Cliente Natural</a>
                <a hre="#frmClienteJur" data-val="1" class="btn btn-default" role="button">Cliente Jurídico</a>
            </div>
            <div class="hr-line-dashed"></div>
            <div id="msg">
            </div>
            <div>
                <form role="form" data-toggle="validator" action="/Cliente/RegistrarPersNatural" autocomplete="off" id="frmClienteNat" method="post" class="form-horizontal ng-pristine ng-valid">
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Nombre</label>
                        <div class="col-md-7">
                            <input id="hdnPersNatId" type="hidden" name="PersNat.oPers.nPersId" />
                            <input type="text" id="txtNom" name="PersNat.cPersNatNombre" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Apellido</label>
                        <div class="col-md-7">
                            <input type="text" id="txtApe" name="PersNat.cPersNatApellido" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">DOI</label>
                        <div class="col-md-4">
                            <input type="text" pattern="[0-9]{8}" onkeypress="return val_09(event)" maxlength="8" id="txtDOI" name="PersNat.cPersNatDOI" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Fecha de Nacimiento</label>
                        <div class="col-md-4">
                            <input type="text" id="txtFechaNac" name="PersNat.dPersNatNac" class="form-control" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    <div class="form-group m-b-8">
                        <label class="col-md-4 control-label">Sexo</label>
                        <div id="cmbSex" class="col-md-7">
                            <label class="radio-inline">
                                <input type="radio" name="PersNat.oPersNatSexo.cConstanteID" value="M" checked="">Masculino</label>
                            <label class="radio-inline">
                                <input type="radio" name="PersNat.oPersNatSexo.cConstanteID" value="F">Femenino</label>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Email</label>
                        <div class="col-md-7">
                            <input type="email" id="txtNatEmail" name="PersNat.oPers.cPersEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Teléfono 1</label>
                        <div class="col-md-4">
                            <input type="text" id="txtNatTel1" onkeypress="return val_09(event)" name="PersNat.oPers.cPersTelefono1" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Teléfono 2</label>
                        <div class="col-md-4">
                            <input type="text" id="txtNatTel2" onkeypress="return val_09(event)" name="PersNat.oPers.cPersTelefono2" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Dirección</label>
                        <div class="col-md-7">
                            <input type="text" id="txtNatDir" name="PersNat.oPers.cPersDireccion" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Departamento</label>
                        <div class="col-md-4">
                            <select id="cmbNatDep" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Provincia</label>
                        <div class="col-md-4">
                            <select id="cmbNatProv" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Distrito</label>
                        <div class="col-md-4">
                            <select id="cmbNatDist" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>
                    <div class="row m-b-10 m-t-10">
                        <div class="text-center">
                            <input type="button" id="btnGrabarNat" class="btn btn-sm btn-primary m-r-5" value="Grabar" />
                            <input type="button" id="btnCanNat" data-dismiss="modal" aria-hidden="true" class="btn btn-sm btn-default m-r-5" value="Cancelar" />
                        </div>
                    </div>
                    <div id="cntHiddenNat"></div>
                </form>
                <form action="/Cliente/RegistrarPersJuridica" autocomplete="off" id="frmClienteJur" style="display: none;" method="post" class="form-horizontal ng-pristine ng-valid">
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Empresa</label>
                        <div class="col-md-7">
                            <input id="hdnPersJurId" type="hidden" name="PersJur.oPers.nPersId" />
                            <input type="text" id="txtEmp" name="PersJur.cPersJurEmpresa" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Representante</label>
                        <div class="col-md-7">
                            <input type="text" id="txtRep" name="PersJur.cPersJurRep" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">RUC</label>
                        <div class="col-md-3">
                            <input type="text" pattern="[0-9]{11}" id="txtRUC" maxlength="11" name="PersJur.cPersJurRUC" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Fecha de Constitución</label>
                        <div class="col-md-3">
                            <input type="text" id="txtFechaConst" name="PersJur.dPersJurFecConst" class="form-control" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Actividad</label>
                        <div class="col-md-4">
                            <select id="cmbActividad" name="PersJur.oPersJurActividad.cConstanteID" class="form-control">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Email</label>
                        <div class="col-md-7">
                            <input type="text" id="txtJurEmail" name="PersJur.oPers.cPersEmail" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Teléfono 1</label>
                        <div class="col-md-4">
                            <input type="text" id="txtJurTel1" name="PersJur.oPers.cPersTelefono1" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Teléfono 2</label>
                        <div class="col-md-4">
                            <input type="text" onkeypress="return val_09(event)" id="txtJurTel2" name="PersJur.oPers.cPersTelefono2" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Dirección</label>
                        <div class="col-md-7">
                            <input type="text" onkeypress="return val_09(event)" id="txtJurDir" name="PersJur.oPers.cPersDireccion" class="form-control">
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Departamento</label>
                        <div class="col-md-4">
                            <select id="cmbJurDep" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Provincia</label>
                        <div class="col-md-4">
                            <select id="cmbJurProv" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group m-b-5">
                        <label class="col-md-4 control-label">Distrito</label>
                        <div class="col-md-4">
                            <select id="cmbJurDist" class="form-control">
                                <option value="">-SELECCIONE-</option>
                            </select>
                        </div>
                    </div>
                    <div class="row m-b-10 m-t-10">
                        <div class="text-center">
                            <input type="button" id="btnGrabarJur" class="btn btn-sm btn-primary m-r-5" value="Grabar" />
                            <input type="button" id="btnCanJur" class="btn btn-sm btn-default m-r-5" value="Cancelar" />
                        </div>
                    </div>
                    <div id="cntHiddenJur"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    jQuery(function ($) {
        $("#txtFechaNac,#txtFechaConst").mask("99/99/9999", { placeholder: "dd/mm/yyyy" });

        $('input.target').click(function () {
            vista($(this).attr('href'));
        });

        $("#btnCliente a").click(function () {
            var $target = $($(this).attr('hre')),
                $other = $target.siblings();

            $("#btnCliente a").removeClass("btn-primary");
            $(this).addClass("btn-primary");
            $target.show();
            $other.hide();
        });
    });

    var vista = function ($target) {
        var $target = $($target),
            $other = $('.panel.active');

        if (!$target.hasClass('active')) {
            $other.each(function (index, self) {
                var $this = $(this);
                $this.removeClass('active').animate({
                    left: $this.width()
                }, 500).hide();
            });

            $target.addClass('active').show().css({
                left: -($target.width())
            }).animate({
                left: 0
            }, 500);
        }
    };

    ListaCliente();

    function ListaCliente(nPage, nSize) {

        var nCliId, cCliDesc, cCliDOI;
        var tpoBsq = $("#cmbTpoBsq").val();
        var valor = $("#txtValor").val();
        valor = valor == "" ? null : valor;
        $("#hdnPag").val(nPage);


        switch (tpoBsq) {
            case "1":
                {
                    nCliId = valor;
                    break;
                }
            case "2":
                {
                    cCliDesc = valor;
                    break;
                }
            case "3":
                {
                    cCliDOI = valor;
                    break;
                }
        }

        $.fn.Conexion({
            direccion: '/Cliente/ListaClientesPag',
            datos: { "nPage": nPage, "nSize": nSize, "nCliId": nCliId, "cCliDesc": cCliDesc, "cCliDOI": cCliDOI },
            terminado: function (data) {
                var d = JSON.parse(data);

                $("#cntListaClientes").Tabla({
                    tblId: "tblClientes",
                    cabecera: "Codígo,Nombre,Sexo,DOI,Tipo,Teléfono,Dirección",
                    campos: "id,nom,sexo,doi,tipo,tel1,direc",
                    scrollVertical: "Si",
                    cellLen: "70,364,60,125,60,100,250,60,60",
                    alinear: "C,L,C,C,C,C,L",
                    cantRegVertical: 15,
                    pag: true,
                    pagDato: { "nPage": d.nPage, "nPageTot": d.nPageTot, "nPageSize": d.nPageSize, "nRows": d.nRows },
                    pagEvent: ListaCliente,
                    edit: @if (FrontUser.TienePermiso(RolesPermisos.Clie_Editar_Cliente)){<text>(true)</text>}else{ <text>(false)</text> },
                    elim: @if (FrontUser.TienePermiso(RolesPermisos.Clie_Eliminar_Cliente)){<text>(true)</text>}else{ <text>(false)</text> },
                    dblClick: @if (FrontUser.TienePermiso(RolesPermisos.Clie_Editar_Cliente)){<text>(true)</text>}else{ <text>(false)</text> },
                    editEvent: function (fila) {
                        var nPersId = fila.find("td").eq(0).html();
                        var cTipo = fila.find("td").eq(4).html();
                        $("#hdnEstado").val("E");
                        $('input.target')[0].click();

                        $.fn.Conexion({
                            direccion: '/Cliente/CargoDatosCliente',
                            datos: { "nPersId": nPersId, "cTipo": cTipo },
                            terminado: function (data, textStatus, jqXHR) {
                                var oPers = JSON.parse(data);

                                if (cTipo == "N") {
                                    $("#hdnPersNatId").val(oPers.oPers.id);
                                    $("#txtNom").val(oPers.cNom);
                                    $("#txtApe").val(oPers.cApe);
                                    $("#txtDOI").val(oPers.cDOI);
                                    $("#txtFechaNac").val(moment(oPers.dNac).format("DD/MM/YYYY"));
                                    $("#txtNatEmail").val(oPers.oPers.mail);
                                    $("#txtNatTel1").val(oPers.oPers.tel1);
                                    $("#txtNatTel2").val(oPers.oPers.tel2);
                                    $("#txtNatDir").val(oPers.oPers.direc);
                                    $("#cmbSex input:radio").val([oPers.oSexo.id]);
                                    $("#btnCliente a")[0].click();
                                    $($("#btnCliente a")[1]).attr("disabled", true);
                                    //CargaDep();
                                    //CargaProv();
                                    //CargaDist();
                                    $("#cmbNatDep").val(oPers.oPers.oUbigeo.id.substring(0, 2))
                                    $("#cmbNatDep").change();
                                    $("#cmbNatProv").val(oPers.oPers.oUbigeo.id.substring(2, 4))    
                                    $("#cmbNatProv").change();
                                    $("#cmbNatDist").val(oPers.oPers.oUbigeo.id.substring(4, 6))
                                } else if (cTipo == "J") {
                                    $("#hdnPersJurId").val(oPers.oPers.id);
                                    $("#txtEmp").val(oPers.cEmpresa);
                                    $("#txtRep").val(oPers.cRep);
                                    $("#txtRUC").val(oPers.cRUC);
                                    $("#txtFechaConst").val(moment(oPers.dConst).format("DD/MM/YYYY"));
                                    $("#txtJurEmail").val(oPers.oPers.mail);
                                    $("#txtJurTel1").val(oPers.oPers.tel1);
                                    $("#txtJurTel2").val(oPers.oPers.tel2);
                                    $("#txtJurDir").val(oPers.oPers.direc);
                                    $("#btnCliente a")[1].click();
                                    $($("#btnCliente a")[0]).attr("disabled", true);
                                }
                            },
                            bloqueo: false
                        });
                    },
                    elimEvent: function (fila,nPage) {
                        var nPersId = fila.find("td").eq(0).html();

                        $.fn.Conexion({
                            direccion: '/Cliente/EliminarCliente',
                            datos: { "nPersId": nPersId },
                            terminado: function (data, textStatus, jqXHR) {
                                ListaCliente(nPage, 10);
                            },
                            bloqueo: false
                        });

                    },
                    datos: d.oLista
                });
            }
        });
    }

    $("#btnBuscarCli").bind("click", function () {
        ListaCliente();
    });

    $("#txtValor").keyup(function (e) {
        if (e.which == 13) { ListaCliente(); }
    });



    //Registrar Clientes Natural

    $("#btnGrabarNat").click(function () {
        var form = $("#frmClienteNat");
        form.validator();

        var validator = form.data("bs.validator");
        validator.validate();

        if (!validator.hasErrors()) {

            CrearHidden("#cntHiddenNat", "PersNat.oPers.oPersUbigeo.cConstanteID", $("#cmbNatDep").val() + $("#cmbNatProv").val() + $("#cmbNatDist").val());

            valores = form.serializeArray();
            $("#cntHidden input").remove();

            $.fn.Conexion({
                direccion: form.attr("action"),
                datos: valores,
                terminado: function (data, textStatus, jqXHR) {
                    if (data == -2) {
                        alerta("#msg", "Existe un cliente registrado con el mismo DNI.");
                        $("#txtDOI").parent().parent().addClass("has-error has-danger");
                        $("#txtDOI").focus();
                    } else {
                        Resultado(data);
                    }
                },
                bloqueo: true
            });
        } else {
            alerta("#msg", "Es necesario completar los campos que están en rojo.");
        }
    });

    //Registrar Cliente Juridico

    $("#btnGrabarJur").bind("click", function () {
        var form = $("#frmClienteJur");
        form.validator();

        var validator = form.data("bs.validator");
        validator.validate();

        if (!validator.hasErrors()) {
            CrearHidden("#cntHiddenJur", "PersonaJur.oPers.oPersUbigeo.cConstanteID", $("#cmbJurDep").val() + $("#cmbJurProv").val() + $("#cmbJurDist").val());

            valores = form.serializeArray();

            $.fn.Conexion({
                direccion: form.attr("action"),
                datos: valores,
                terminado: function (data, textStatus, jqXHR) {
                    if (data == -2) {
                        alerta("#msg", "Existe un cliente registrado con el mismo RUC.");
                        $("#txtRUC").parent().parent().addClass("has-error has-danger");
                        $("#txtRUC").focus();
                    } else {
                        Resultado(data);
                    }
                },
                bloqueo: true
            });
        } else {
            alerta("#msg", "Es necesario completar los campos que están en rojo.");
        }
    });


    $("#btnCanNat,#btnCanJur").bind("click", function () {
        Limpiar();
    });

    function Limpiar() {
        $('#frmClienteNat')[0].reset();
        $('#frmClienteJur')[0].reset();
        $("#btnCliente a").attr("disabled", false);
        $("#btnCliente a")[0].click();
        $("#msg").html("");
        vista("#target1");
    }

    //Combo Ubigeo
    Lista('cmbNatDep', 'cmbJurDep', null, '/Cliente/ListaDep');

    function Lista(natId,jurId,par,dir) {
        $.fn.Conexion({
            direccion: dir,
            datos: {"cId": par},
            terminado: function (data) {
                var cons = JSON.parse(data);

                if (natId == "cmbNatDep") {
                    CrearLista("#" + natId, cons);
                    CrearLista("#" + jurId, cons);
                }

                if ($("#btnCliente a.btn-primary").attr("data-val") == "0") {
                    CrearLista("#" + natId, cons);
                } else {
                    CrearLista("#" + jurId, cons);
                }
            }
        });
    }

    $("body").on("change", "#cmbNatDep,#cmbJurDep", function () {
        Lista("cmbNatProv","cmbJurProv", this.value, '/Cliente/ListaProv');
    });

    $("body").on("change", "#cmbNatProv,#cmbJurProv", function () {
        Lista("cmbNatDist", "cmbJurDist", this.value, '/Cliente/ListaDist');
    });

    $("body").on("change", "#cmbNatDep,#cmbJurDep,#cmbNatProv,#cmbJurProv", function () {
        var combos = [];

        switch ($(this).attr("id")) {
            case "cmbNatDep": { combos = ["cmbNatProv", "cmbNatDist"]; break; }
            case "cmbNatProv": { combos = ["cmbNatDist"]; break; }
            case "cmbJurDep": { combos = ["cmbJurProv", "cmbJurDist"]; break; }
            case "cmbJurProv": { combos = ["cmbJurDist"]; break; }
        }

        LimpiaOptCombos(combos);
    });


    function Resultado(dato) {
        if (dato != -1) {
            if ($("#hdnEstado").val() == "E") {
                $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Se modificó el cliente correctamente", funcionAceptar: Limpiar });
            } else {
                $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Se registró el cliente correctamente" , funcionAceptar: Limpiar});
            }
            ListaCliente($("#hdnPag").val(), 10);
        } else {
            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente" });
        }
    }

</script>
