@{
    Layout = null;
}
<div class="col-lg-11 col-lg-offset-0-5">
    @*<div class="row color19">*@
    <input id="hdnEstado" type="hidden" />
    <input id="hdnNotaEst" type="hidden" />
    <input id="hdnPag" type="hidden" />
    <div id="target1" class="panel move panel-inverse active">
        <div class="panel-heading"><span class="glyphicon glyphicon-th" aria-hidden="true"></span>Lista de Nota de Entregas</div>
        <div class="panel-body">

            <div class="row">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">

                    @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Crear_Nueva_Nota_de_Entrega))
                    {
                        <input href="#target2" id="btnNuevaNota" type="button" class="btn btn-sm btn-success target" value="Nueva Nota de Entrega" />
                    }

                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="row m-b-10 m-t-10">
                <div class="col-sm-11">
                    <div class="form-inline">
                        <div class="form-group m-r-40">
                            <label class="control-label m-r-5" for="status">Mostrar notas por:</label>
                            <select name="status" id="cmbNotaEstado" class="form-control">
                                <option value="1" selected="">Pendiente</option>
                                <option value="2">Pagado</option>
                                <option value="3">Entregado</option>
                                <option value="4">Anulado</option>
                            </select>
                        </div>
                        <div class="form-group m-r-10">
                            <label class="control-label m-r-5" for="product_name">Buscar por:</label>
                            <select name="status" id="cmbTpoBsq" class="form-control">
                                <option value="1" selected="">Nombre</option>
                                <option value="2">Codigo Nota</option>
                                <option value="3">DOI</option>
                                <option value="4">Rango de Fecha</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="text" id="txtValor" class="form-control">
                            <div class="input-daterange input-group" id="dtRango" style="display: none;">
                                <input id="txtFI" type="text" class="form-control" name="start">
                                <span class="input-group-addon">al</span>
                                <input id="txtFF" type="text" class="form-control" name="end">
                            </div>
                        </div>
                        <input id="btnBuscarNota" type="button" value="Buscar" class="btn btn-sm btn-primary">
                        @*<input type="text" id="txtBuscar" class="form-control">*@
                    </div>
                </div>
            </div>
            <div class="row table-main">
                <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                    <div id="cntListaNotaEntrega" class="table-responsive">
                    </div>
                    @*<div id="cntListaNotaEntPend" class="table-responsive">
                    </div>*@
                </div>
            </div>
        </div>
    </div>

    @*Formulario Nota de Entrega*@
    <div id="target2" class="panel move panel-inverse" data-sortable-id="form-stuff-1" style="display: none;">
        <div class="panel-heading">
            <h4 class="panel-title">Nueva Nota de Entrega</h4>
        </div>
        <div class="panel-body" style="display: block;">
            <div class="row m-b-10">
                <div class="col-lg-3">
                    <div class="form-inline">
                        <div class="form-group">
                            <label for="exampleInputName2">Código Nota</label>
                            <input type="text" class="form-control" id="txtCodNota" placeholder="" disabled>
                            <input id="hdnNotaId" type="hidden">
                        </div>
                    </div>
                </div>
                <div class="col-sm-3 col-lg-3 text-center">
                    @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Cobrar_Nota_de_Entrega))
                    {
                        <input id="btnCobrarNota" type="button" class="btn btn-sm btn-primary m-r-5" value="S/. Cobrar" disabled>
                    }

                    @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Confirmar_Entrega))
                    {
                        <button id="btnConfirmarEntrega" type="button" class="btn btn-success btn-sm" disabled>
                            <span class="glyphicon glyphicon-thumbs-up" aria-hidden="true"></span>Confirmar Entrega
                        </button>
                    }

                </div>
                <div class="col-sm-3 col-lg-6 text-right">
                    @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Anular_Nota_de_Entrega))
                    {
                        <input id="btnAnularNota" type="button" class="btn btn-sm btn-danger m-r-5" value="Anular Nota" disabled>
                    }
                    @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Anular_Comprobante))
                    {
                        <input id="btnAnularComp" type="button" class="btn btn-sm btn-danger m-r-5" value="Anular Comprobante" disabled>
                    }
                </div>
            </div>
            <div class="hr-line-dashed"></div>
            <div class="row">
                <div class="col-lg-12">
                    <form action="/NotaEntrega/RegistrarNotaEntrega" autocomplete="off" id="frmNotaEntrega" method="post">
                        <div class="row m-b-5">
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-3">
                                <div class="form-inline ng-pristine ng-valid">
                                    <div class="form-group">
                                        <input type="text" class="form-control " id="txtBuscarCliente" placeholder="Buscar cliente...">
                                        <button id="btnBuscarPers" type="button" class="btn btn-sm btn-default" data-toggle="modal"><span class="glyphicon glyphicon-search"></span></button>
                                    </div>
                                </div>

                            </div>
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-5">
                                <h3 class="m-t-10 m-b-5" style="margin-top: 7px; font-size: 18px;"><i class="glyphicon glyphicon-user m-r-10"></i>
                                    <input id="hdnPersId" type="hidden" name="oNotEnt.oPers.nPersId"><span id="lblNom"></span></h3>
                            </div>
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-2">
                                <h3 class="m-t-10 m-b-5" style="margin-top: 7px; font-size: 18px;"><i class="glyphicon glyphicon-asterisk m-r-10"></i><span id="lblDOI"></span></h3>
                            </div>
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-2">
                                <h3 class="m-t-10 m-b-5" style="margin-top: 7px; font-size: 18px;"><i class="glyphicon glyphicon-earphone m-r-10"></i><span id="lblTel"></span></h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-3">
                                <div class="form-inline ng-pristine ng-valid">
                                    <div class="form-group">
                                        <input type="text" class="form-control " id="txtBuscarProducto" placeholder="Buscar producto...">
                                        <button id="btnBuscarProd" type="button" class="btn btn-sm btn-default" data-toggle="modal"><span class="glyphicon glyphicon-search"></span></button>
                                    </div>
                                </div>

                            </div>
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-9s">
                                <h3 class="m-t-5 m-b-5" style="margin-top: 7px; font-size: 18px;">
                                    <span id="lblProducto" style="color: rgb(78, 130, 212);"></span>
                                </h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-horizontal">
                                    <div class="form-group m-b-5">
                                        <label class="col-lg-2  control-label">Servicios</label>
                                        <div class="col-lg-6">
                                            <label class="checkbox-inline">
                                                <input id="chkLav" type="checkbox" value="true" disabled>Lavado</label>
                                            <label class="checkbox-inline">
                                                <input id="chkSec" type="checkbox" value="true" disabled>Secado</label>
                                            <label class="checkbox-inline">
                                                <input id="chkPla" type="checkbox" value="true" disabled>Planchado</label>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-lg-2  control-label">Cant./Peso</label>
                                        <div class="col-lg-3">
                                            <input type="text" id="txtCant" class="form-control" placeholder="">
                                            <input id="hdnMedida" type="hidden">
                                        </div>
                                        <div id="cntDescProd" class="form-group m-b-0" style="display: none;">
                                            <label class="col-lg-1  control-label">Desc.</label>
                                            <div class="col-lg-4">
                                                <input type="text" id="txtDescProd" name="" class="form-control" placeholder="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-lg-2  control-label">Precio Unit.</label>
                                        <div class="col-lg-3">
                                            <input type="text" id="txtPrec" class="form-control" placeholder="" disabled="">
                                        </div>
                                        <div id="cntMedida" class="form-group m-b-0" style="display: none;">
                                            <label class="col-lg-1  control-label">Medida</label>
                                            <div class="col-lg-3">
                                                <select id="cmbMedida" name="" class="form-control">
                                                    <option value="1">Kg</option>
                                                    <option value="2">Prenda</option>
                                                </select>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-lg-2  control-label">Importe</label>
                                        <div class="col-lg-3">
                                            <input type="text" id="txtImp" class="form-control" placeholder="" disabled="">
                                        </div>
                                        <div class="col-lg-7">
                                            <input id="btnAgregar" type="button" class="btn btn-sm btn-success" value="Agregar">
                                            <input id="btnEditar" type="button" class="btn btn-sm btn-success" value="Editar">
                                            <input id="btnCancelar" type="button" class="btn btn-sm btn-success" value="Cancelar">
                                            <input id="btnEliminar" type="button" class="btn btn-sm btn-success" value="Eliminar">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row m-b-10">
                            <div class="col-xs-12 col-sm-9 col-md-9 col-lg-12">
                                <div id="cntRegProd" class="table-responsive">
                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="row">
                            <div class="col-lg-5 col-md-offset-4">
                                <div class="form-horizontal">
                                    <div class="form-group m-b-5">
                                        <label class="col-md-3 control-label">Atendido por</label>
                                        <div class="col-md-5">
                                            <select name="oNotEnt.cNotaUsuAtiende" id="cmbUsuCaj" class="form-control manito" required="">
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-md-3 control-label">Recoger</label>
                                        <div class="col-md-5">
                                            <input type="text" id="txtFechaEnt" name="oNotEnt.dFechaEntrega" class="form-control">
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-md-3 control-label">Comentario</label>
                                        <div class="col-md-7">
                                            <textarea id="txtCom" name="oNotEnt.cNotaComentario" maxlength="250" class="form-control" rows="4"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-horizontal">

                                    <div class="form-group m-b-5">
                                        <label class="col-md-6 control-label">Subtotal</label>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">S/.</span>
                                                <input type="text" id="txtSubTotal" name="oNotEnt.nNotaSubTotal" class="form-control" placeholder="0.00" readonly="">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-md-6 control-label">Descuento</label>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">S/.</span>
                                                <input type="text" id="txtDescuento" name="oNotEnt.nNotaDescuento" onkeypress="return val_09D(event)" class="form-control" placeholder="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-md-6 control-label">Adelanto</label>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">S/.</span>
                                                <input type="text" id="txtAnticipo" name="oNotEnt.nNotaAnticipo" onkeypress="return val_09D(event)" class="form-control" placeholder="0.00">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group m-b-5">
                                        <label class="col-md-6 control-label">Total</label>
                                        <div class="col-md-6">
                                            <div class="input-group">
                                                <span class="input-group-addon">S/.</span>
                                                <input type="text" id="txtTotal" name="oNotEnt.nNotaMontoTotal" class="form-control" placeholder="0.00" readonly="">
                                            </div>
                                        </div>
                                    </div>
                                    <div id="cntHidden"></div>

                                </div>
                            </div>
                        </div>
                        <div class="hr-line-dashed"></div>
                        <div class="row">
                            <div class="col-lg-12 text-right">
                                <input id="btnModCom" style="display: none;" type="button" value="Guardar Comentario" class="btn btn-sm btn-primary target m-r-5">
                                <input id="btnGrabarEnt" type="button" value="Guardar" class="btn btn-sm btn-primary target m-r-5">
                                <input id="btnCanEnt" type="button" value="Cancelar" class="btn btn-sm btn-default target">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</div>


<div class="modal fade" id="vntAnticipo" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-focus-on="input:first">
    <div style="width: 250px;" class="modal-dialog">
        <div class="panel panel-inverse">
            <div class="panel-heading">
                Cobrar Anticipo
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="margin-top: 0px;">×</button>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="form-horizontal">

                        <div class="form-group m-b-5">
                            <label class="col-md-4 control-label">Adelanto</label>
                            <div class="col-md-7">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtAnticipoT" class="form-control" placeholder="0.00" readonly="readonly">
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-b-5">
                            <label class="col-md-4 control-label">Efectivo</label>
                            <div class="col-md-7">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtEfectivo" class="form-control" autocomplete="off" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-b-10">
                            <label class="col-md-4 control-label">Cambio</label>
                            <div class="col-md-7">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtCambio" class="form-control" placeholder="0.00" readonly="readonly">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-right">
                        <button id="btnAceptarAnt" type="submit" class="btn btn-sm btn-primary m-r-5">Aceptar</button>
                        <button id="btnCancelarAnt" type="submit" data-dismiss="modal" aria-hidden="true" class="btn btn-sm btn-default">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="vntCobroCancelacion" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-focus-on="input:first">
    <div style="width: 800px;" class="modal-dialog">
        <div class="panel panel-inverse">
            <div class="panel-heading">
                Cobro Total
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true" style="margin-top: 0px;">×</button>
            </div>
            <div class="panel-body" style="display: block;">
                <div id="msg">
                </div>
                <form id="frmCobroTotal" data-toggle="validator" class="form-horizontal ng-pristine ng-valid" autocomplete="off">
                    <div>
                        @*<div id="cntProveedor" style="display: block;">
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Tipo Comprobante</label>
                                <div class="col-md-7">
                                    <select name="status" id="cmbTipoComp" class="form-control" required>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Cliente</label>
                                <div class="col-md-8 form-inline">
                                    <input id="hdnCliBoId" type="hidden" name="">
                                    <input type="text" id="txtBuscarCliBo" name="" class="form-control" placeholder="">
                                    <button id="btnBuscarCliBo" type="button" class="btn btn-sm btn-default" data-toggle="modal">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Nombre</label>
                                <div class="col-md-7">
                                    <input type="text" id="txtNombrePe" name="" class="form-control" readonly="">
                                </div>
                            </div>
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">DOI</label>
                                <div class="col-md-7">
                                    <input type="text" id="txtDOIPe" name="" class="form-control" readonly="">
                                </div>
                            </div>
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Total</label>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon">S/.</span>
                                        <input type="text" id="txtTotalC" class="form-control" placeholder="0.00" readonly="readonly">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Efectivo</label>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon">S/.</span>
                                        <input type="text" id="txtEfectivoC" onkeypress="return val_09D(event)" class="form-control" autocomplete="off" placeholder="0.00" required>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group m-b-5">
                                <label class="col-md-4 control-label">Cambio</label>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-addon">S/.</span>
                                        <input type="text" id="txtCambioC" class="form-control" placeholder="0.00" readonly="readonly">
                                    </div>
                                </div>
                            </div>
                        </div>*@
                        <div class="form-group m-b-5">
                            <label class="col-md-2 control-label">Buscar Cliente</label>
                            <div class="col-md-4 form-inline">
                                <input id="hdnCliBoId" type="hidden" name="" value="">
                                <input type="text" style="width: 205px;" id="txtBuscarCliBo" name="" class="form-control" placeholder="">
                                <button id="btnBuscarCliBo" type="button" class="btn btn-sm btn-default" data-toggle="modal">
                                    <span class="glyphicon glyphicon-search"></span>
                                </button>
                            </div>
                            <input type="button" id="btnNuevoCli" class="btn btn-sm btn-success m-l-25" value="Nuevo Cliente">
                            <input type="button" id="btnGuardarCli" class="btn btn-sm btn-primary m-l-5" value="Guardar Cliente">
                        </div>
                        <div class="form-group m-b-5">
                            <label class="col-md-2 control-label">Nombre</label><div class="col-md-4">
                                <input type="text" style="" id="txtNombrePe" name="" class="form-control" disabled>
                            </div>
                            <label class="col-md-2 control-label">DNI / RUC</label>
                            <div class="col-md-2">
                                <input type="text" id="txtDOIPe" name="" class="form-control" disabled>
                            </div>
                        </div>
                        <div class="form-group m-b-5">
                            <label class="col-md-2 control-label">Dirección</label>
                            <div class="col-md-4">
                                <input type="text" id="txtDirecc" name="" class="form-control" disabled>
                            </div>
                            <label class="col-md-2 control-label">Tipo Comprobante</label>

                            <div class="col-md-2">
                                <select name="status" id="cmbTipoComp" class="form-control" required="">
                                    <option value="">-SELECCIONE-</option>
                                    <option value="1">BOLETA</option>
                                    <option value="2">FACTURA</option>
                                </select>
                            </div>
                            <label class="col-md-2 checkbox-inline">
                                <input id="chkMultiple" type="checkbox" name="" value="true">Multiple</label>
                        </div>
                        <div id="cntMultiple" class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                            <div class="hr-line-dashed"></div>
                            <div class="form-group m-b-10">
                                <label style="text-align: left;" class=" col-md-1 control-label ">Buscar</label>
                                <div class="col-md-11">
                                    <input type="text" id="txtBuscarNota" name="" class="form-control" style="text-align: left;" disabled>
                                </div>
                            </div>
                            <div id="cntListaNotaEntPend" class="table-responsive">
                            </div>
                            <div class="hr-line-dashed"></div>
                        </div>
                        <div class="form-group m-b-5">
                            <label class="col-md-5 control-label">Total</label>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtTotalC" class="form-control" placeholder="0.00" readonly="readonly">
                                </div>
                            </div>
                        </div>

                        <div class="form-group m-b-5">
                            <label class="col-md-5 control-label">Efectivo</label>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtEfectivoC" onkeypress="return val_09D(event)" class="form-control" autocomplete="off" placeholder="0.00" required="">
                                </div>
                            </div>
                        </div>
                        <div class="form-group m-b-5">
                            <label class="col-md-5 control-label">Cambio</label>
                            <div class="col-md-3">
                                <div class="input-group">
                                    <span class="input-group-addon">S/.</span>
                                    <input type="text" id="txtCambioC" class="form-control" placeholder="0.00" readonly="readonly">
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="hr-line-dashed"></div>
                    <div class="row">
                        <div class="text-center">
                            <input type="button" id="btnAceptarC" class="btn btn-sm btn-primary m-r-5" value="Aceptar">
                            <input type="button" id="btnCancelarC" data-dismiss="modal" aria-hidden="true" class="btn btn-sm btn-default" value="Cancelar">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    jQuery(function ($) {

        DeshabilitarBotones();
        SetRangoFecha("#dtRango");

        $('#txtFechaEnt').datetimepicker({
            locale: 'es', format: 'DD/MM/YYYY hh:mm A'
        });

        $('input.target').click(function () {
            vista($(this).attr('href'));
        });

        $('#btnNuevaNota').click(function () {
            $("#txtBuscarCliente").focus();
        });
    });

    var vista = function ($target) {
        var $target = $($target),
            $other = $target.siblings('.active');

        if (!$target.hasClass('active')) {
            $other.each(function (index, self) {
                var $this = $(this);
                $this.removeClass('active').animate({
                    left: $this.width()
                }, 500).hide();
            });

            $target.addClass('active').show().css({
                left: -($target.width())
            }).animate({
                left: 0
            }, 500);
        }
    };


    ListarNotaEntrega();

    function ListarNotaEntrega(nPage, nSize) {

        var nNotaEst, cPersDOI, nNotaEntId, cPersDesc, dIni, dFin;
        var tpoBsq = $("#cmbTpoBsq").val();
        var valor = $("#txtValor").val();
        valor = valor == "" ? null : valor;
        nNotaEst = $("#cmbNotaEstado").val();
        $("#hdnPag").val(nPage);

        switch (tpoBsq) {
            case "1":
                {
                    cPersDesc = valor;
                    break;
                }
            case "2":
                {
                    nNotaEntId = valor;
                    break;
                }
            case "3":
                {
                    cPersDOI = valor;
                    break;
                }
            case "4":
                {
                    dIni = $("#txtFI").val();
                    dIni = dIni == "" ? null : dIni;
                    dFin = $("#txtFF").val();
                    dFin = dFin == "" ? null : dFin;
                    break;
                }
        }


        $.fn.Conexion({
            direccion: '/NotaEntrega/BuscarNotaEntPag',
            datos: { "nNotaEst": nNotaEst, "nPage": nPage, "nSize": nSize, "nNotaEntId": nNotaEntId, "cPersDOI": cPersDOI, "cPersDesc": cPersDesc, "dIni": dIni, "dFin": dFin },
            terminado: function (data) {
                var d = JSON.parse(data);

                $("#cntListaNotaEntrega").Tabla({
                    tblId: "tblNotaEntrega",
                    cabecera: "Cod. Nota,Cliente,DOI,Fecha Registro,Fecha Entrega,Adelanto,Pendiente de Pago",
                    campos: "nNotaEntId,oPers.nom,oPers.doi,dFecReg,dFecEnt,nNotaAnt,nNotaMonTot",
                    scrollVertical: "Si",
                    tipoCampo: ",,,F,F,D,D",
                    alinear: "C,C,C,C,C,C,C",
                    cellLen: "80,364,125,150,150,100,150,60",
                    cantRegVertical: 15,
                    pag: true,
                    pagDato: { "nPage": d.nPage, "nPageTot": d.nPageTot, "nPageSize": d.nPageSize, "nRows": d.nRows },
                    pagEvent: ListarNotaEntrega,
                    edit: @if (FrontUser.TienePermiso(RolesPermisos.NotaE_Editar_Nota_de_Entrega))
                          {<text>(true)</text>}
                          else
                          { <text>(false)</text> },
                    dblClick: true,
                    editEvent: function (fila) {
                        var nNotaId = fila.find("td").eq(0).html();
                        $("#hdnEstado").val("E");
                        $('input.target')[0].click();

                        $.fn.Conexion({
                            direccion: '/NotaEntrega/CargoDatosNotaEntrega',
                            datos: { "nNotaId": nNotaId },
                            terminado: function (data, textStatus, jqXHR) {
                                var oNota = JSON.parse(data);
                                $("#hdnPersId").val(oNota.oPers.id);
                                $("#hdnNotaEst").val(oNota.oNotaEst.id);
                                $("#lblNom").html(oNota.oPers.nom);
                                $("#lblDOI").html(oNota.oPers.doi);
                                $("#lblTel").html(oNota.oPers.tel1);
                                $("#txtCodNota").val(oNota.nNotaEntId);
                                $("#hdnNotaId").val(oNota.nNotaEntId);
                                $("#txtCom").val(oNota.cNotaCom);
                                $("#cmbUsuCaj").val(oNota.cNotaUsuAt);
                                $("#txtDescuento").val(number_format(oNota.nNotaDes, 2));
                                $("#txtAnticipo").val(number_format(oNota.nNotaAnt, 2));
                                $('#txtFechaEnt').val(moment(oNota.dFecEnt).format("DD/MM/YYYY hh:mm A"));

                                var lst = oNota.lstNotEntProd;
                                lstProd = [];

                                for (i in lst) {

                                    var obj = {
                                        nPrId: lst[i].oProd.nPrId,
                                        cPrDesc: lst[i].oProd.cPrDesc,
                                        bPrSerLav: lst[i].oProd.bPrSerLav,
                                        bPrSerPla: lst[i].oProd.bPrSerPla,
                                        bPrSerSec: lst[i].oProd.bPrSerSec,
                                        bProdO: lst[i].oProd.bProdO,
                                        oPrMed: { id: lst[i].oProd.oPrMed.id, nom: lst[i].oProd.oPrMed.nom },
                                        nCant: lst[i].nDetCant,
                                        nPrPrecU: lst[i].nPrPrecU,
                                        nImp: lst[i].nDetImp
                                    };
                                    lstProd = lstProd.concat([obj]);
                                }

                                lstProd = lstProd;

                                CrearTabla(lstProd);
                                subTotal(lstProd);


                                if (oNota.oNotaEst.id == 1) {
                                    SetEstadoPendiente();
                                } else if (oNota.oNotaEst.id == 2) {
                                    SetEstadoPagado();
                                } else if (oNota.oNotaEst.id == 3) {
                                    SetEstadoEntregado();
                                } else if (oNota.oNotaEst.id == 4) {
                                    SetEstadoAnulado();
                                }
                            },
                            bloqueo: false
                        });
                    },
                    datos: d.oLista
                });
            }
        });
    }

    ListaConst();

    function ListaConst() {
        $.fn.Conexion({
            direccion: '/NotaEntrega/ListaConstantes',
            terminado: function (data) {
                var cons = JSON.parse(data);

                comboTipoCred = new hCombos();
                comboTipoCred.ids = ['cmbTipoComp'];
                comboTipoCred.pre = [''];
                comboTipoCred.info = cons.lstTpoDoc;
                comboTipoCred.init();

                comboTipoCred = new hCombos();
                comboTipoCred.ids = ['cmbUsuCaj'];
                comboTipoCred.pre = [''];
                comboTipoCred.info = cons.lstUsuarios;
                comboTipoCred.init();
            }
        });
    }

    function SetEstadoPendiente() {
        $("#target2").find("input,button,select").attr("disabled", true);
        $("#btnCobrarNota,#btnAnularNota,#btnCanEnt,#btnModCom").attr("disabled", false);
        $("#btnModCom").show();
        $("#btnGrabarEnt").hide();
        $("#hdnEstado").val("");
        $("#hdnNotaEst").val(1);
    }

    function SetEstadoPagado() {
        $("#target2").find("input,button,select").attr("disabled", true);
        $("#btnConfirmarEntrega,#btnAnularNota,#btnAnularComp,#btnCanEnt,#btnModCom").attr("disabled", false);
        $("#btnCobrarNota").attr("disabled", true);
        $("#btnModCom").show();
        $("#btnGrabarEnt").hide();
        $("#hdnEstado").val("");
        $("#hdnNotaEst").val(2);
    }

    function SetEstadoEntregado() {
        $("#target2").find("input,button").attr("disabled", true);
        $("#btnAnularNota,#btnCanEnt,#btnAnularComp,#btnModCom").attr("disabled", false);
        $("#btnModCom").show();
        $("#btnGrabarEnt").hide();
        $("#hdnEstado").val("");
        $("#hdnNotaEst").val(3);
    }

    function SetEstadoAnulado() {
        $("#target2").find("input,textarea,button").attr("disabled", true);
        $("#btnGrabarEnt").hide();
        $("#hdnEstado").val("");
        $("#hdnNotaEst").val(4);
    }

    $("#cmbTpoBsq").bind("click", function () {
        var tpoProd = $(this).val();
        $("#txtValor").show();
        $("#dtRango").hide();
        if (tpoProd == 4) {
            $("#txtValor").hide();
            $("#dtRango").show();
        }
    });

    $("#cmbNotaEstado").change(function () {
        ListarNotaEntrega();
    });

    $("#btnBuscarNota").bind("click", function () {
        ListarNotaEntrega();
    });

    $("#txtValor").keyup(function (e) {
        if (e.which == 13) { ListarNotaEntrega(); }
    });



    /*Variable Global de Datos*/
    datos = {};

    var lstProd = !datos.lstProd ? [] : datos.lstProd.slice(0);
    var estado = "";

    //Buscar datos persona

    var persSelec = {}

    function BuscarCliente(valor) {
        var aceptar = function (d) {
            persSelec = d;
            $("#hdnPersId").val(d.id);
            $("#lblNom").html(d.nom);
            $("#lblDOI").html(d.doi);
            $("#lblTel").html(d.tel1);
            $('#vntBuscaPersona').modal('hide');
        };

        var cancelar = function () {
            //$("#btnCancelar").click();
        }
        $.fn.BuscarPersona({
            funcionAceptar: aceptar,
            funcionCancelar: cancelar,
            valor: valor,
            focusClose: "txtBuscarCliente"
        });
    }

    $("#btnBuscarPers").bind("click", function () {
        BuscarCliente($("#txtBuscarCliente").val());
    });

    $("#txtBuscarCliente").bind("keyup", function (e) {
        if (e.which == 13) { BuscarCliente($(this).val()); };
    });


    //Buscar datos producto
    $("#txtCant").keyup(function () { $("#txtImp").val(number_format(Math.round10($("#txtCant").val() * $("#txtPrec").val(), -1), 2)) });

    $("#txtPrec").keyup(function () { $("#txtImp").val(number_format(Math.round10($("#txtCant").val() * $("#txtPrec").val(), -1), 2)) });

    var prodSel = {}
    $("#btnBuscarProd").bind("click", function () {
        BuscarProd($("#txtBuscarProducto").val());
    });

    $("#txtBuscarProducto").bind("keyup", function (e) {
        if (e.which == 13) { BuscarProd($(this).val()); };
    });

    function BuscarProd(valor) {
        var aceptar = function (d) {
            prodSel = d;
            LlenarDatos(d);
            ProdVisible(prodSel.bProdO);

            $('#btnAgregar,#btnCancelar').removeAttr("disabled", "disabled");
            $('#btnEliminar,#btnEditar').attr("disabled", true);
            $('#vntBuscaProducto').modal('hide');
        };

        var cancelar = function () {
            //$("#btnCancelar").click();
        }
        $.fn.BuscarProducto({
            funcionAceptar: aceptar,
            funcionCancelar: cancelar,
            valor: valor,
            focusClose: "txtBuscarProducto"
        });
    }

    function ProdVisible(estado) {
        if (estado) {
            $("#cntDescProd").show();
            $("#cntDescProd,#cntMedida").show();
            $("#chkLav,#chkSec,#chkPla,#txtPrec").attr("disabled", !estado);
        } else {
            $("#cntDescProd").hide();
            $("#cntDescProd,#cntMedida").hide();
            $("#chkLav,#chkSec,#chkPla,#txtPrec").attr("disabled", !estado);
        }
    }

    //Tabla Registro de Servicios

    CrearTabla();

    //Agregar nuevo registro

    $("#btnAgregar").bind("click", function () {
        Agregar();
    });

    $("#txtCant").bind("keyup", function (e) {
        if (e.which == 13 && (prodSel != null || estado == "E")) { Agregar(); };
    });

    $("#txtPrec").bind("keyup", function (e) {
        if (e.which == 13 && (prodSel != null || estado == "E")) { Agregar(); };
    });

    $("#btnEditar").bind("click", function () {
        Editar();
    });

    $("#btnCancelar").bind("click", function () {
        LimpiarPro();
    });

    $("#btnEliminar").bind("click", function () {
        Eliminar();
    });

    $("#btnGrabarEnt").bind("click", function () {
        if ($('#txtAnticipo').val() != "") {
            $("#txtAnticipoT").val($("#txtAnticipo").val());
            $('#vntAnticipo').modal('show');
        } else {
            Grabar();
        }
    });

    $("#btnModCom").bind("click", function () {
        var nNotaId = $("#hdnNotaId").val()
        var cCom = $("#txtCom").val();

        $.fn.Conexion({
            direccion: '/NotaEntrega/ModificarComentario',
            datos: { "nNotaId": nNotaId, "cCom": cCom },
            terminado: function (data, textStatus, jqXHR) {
                if (data > 0) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Se modificó el comentario correctamente." });
                } else if (data == -1) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                }
            },
            bloqueo: true
        });
    });




    $("#txtEfectivo").keyup(function () { $("#txtCambio").val(number_format(Math.round10($("#txtAnticipoT").val() - $("#txtEfectivo").val(), -1), 2)) });

    $("#btnAceptarAnt").bind("click", function () {
        CrearHidden("#cntHidden", "oNotEnt.nNotaEfectivo", $("#txtEfectivo").val());
        CrearHidden("#cntHidden", "oNotEnt.nNotaCambio", $("#txtCambio").val());
        $('#vntAnticipo').modal('hide');
        Grabar();
    });


    function Agregar() {
        var nCant = $("#txtCant").val();
        var nPrPrecU = $("#txtPrec").val();
        var nImp = $("#txtImp").val();

        var cPrDesc = $("#txtDescProd").val();
        var oPrMedId = $("#cmbMedida").val();
        var oPrMedNom = $("#cmbMedida").find('option:selected').text();
        var bPrSerLav = $("#chkLav").is(":checked");
        var bPrSerSec = $("#chkSec").is(":checked");
        var bPrSerPla = $("#chkPla").is(":checked");

        if (estado == "E") {
            var index = $("#tblRegProd tr.seleccionado").index();
            lstProd[index].nCant = nCant;
            lstProd[index].nImp = nImp;

            if (lstProd[index].bProdO) {
                lstProd[index].nPrPrecU = nPrPrecU;
                lstProd[index].cPrDesc = "Otros " + "(" + cPrDesc + ")";
                lstProd[index].oPrMed.id = oPrMedId;
                lstProd[index].oPrMed.nom = oPrMedNom;
                lstProd[index].bPrSerLav = bPrSerLav;
                lstProd[index].bPrSerSec = bPrSerSec;
                lstProd[index].bPrSerPla = bPrSerPla;
            }

        } else {

            if (prodSel.bProdO) {
                prodSel.cPrDesc = "Otros " + "(" + cPrDesc + ")";
                prodSel.oPrMed.id = oPrMedId;
                prodSel.oPrMed.nom = oPrMedNom;
                prodSel.bPrSerLav = bPrSerLav;
                prodSel.bPrSerSec = bPrSerSec;
                prodSel.bPrSerPla = bPrSerPla;
            }

            var obj = { nPrId: prodSel.nPrId, cPrDesc: prodSel.cPrDesc, bPrSerLav: prodSel.bPrSerLav, bPrSerSec: prodSel.bPrSerSec, bPrSerPla: prodSel.bPrSerPla, bProdO: prodSel.bProdO, oPrMed: { id: prodSel.oPrMed.id, nom: prodSel.oPrMed.nom }, nCant: nCant, nPrPrecU: nPrPrecU, nImp: nImp };
            lstProd = lstProd.concat([obj]);
        }

        CrearTabla(lstProd);
        subTotal(lstProd);
        LimpiarPro();

        $("#btnEliminar,#btnEditar").attr("disabled", false);
        $("#txtBuscarProducto").focus();

        //$("#btnAgregar,#btnEditar,#btnEliminar").show().removeClass("disabled");
        //$("#btnAceptar,#btnCancelar,#btnAceptarEdi").hide();
        //$("#txtCliente,#txtDoc,#txtNombre,#txtRuc").val("");
        estado = "A";
        prodSel = null;
    }

    function subTotal(lstProd) {
        var subTotal = 0
        for (i in lstProd) { subTotal = subTotal + (lstProd[i].nImp * 1) }
        $("#txtSubTotal").val(number_format(subTotal, 2));
        $("#txtTotal").val(number_format($("#txtSubTotal").val() - $("#txtDescuento").val() - $("#txtAnticipo").val(), 2));
    }

    $("#txtAnticipo").keyup(function () { $("#txtTotal").val(number_format(Math.round10($("#txtSubTotal").val() - $("#txtDescuento").val() - $("#txtAnticipo").val(), -1), 2)) });
    $("#txtDescuento").keyup(function () { $("#txtTotal").val(number_format(Math.round10($("#txtSubTotal").val() - $("#txtDescuento").val() - $("#txtAnticipo").val(), -1), 2)) });


    function Editar() {
        var index = $("#tblRegProd tr.seleccionado").index();

        if (index == -1) {
            $.fn.Mensaje({ mensaje: "Seleccione un producto para editar", tamano: "sm" });
            return false;
        } else {
            $("#lblProducto").html(lstProd[index].cDesc);
            estado = "E";
            LlenarDatos(lstProd[index]);


            $("#tblRegProd").attr("data-edit", true);
            $("#btnEditar,#btnEliminar").attr("disabled", true);
            $("#btnAgregar,#btnCancelar").attr("disabled", false);
            $("#txtCant").focus();
        }
    }


    function LimpiarPro() {
        $("#txtCant,#txtPrec,#txtImp,#txtBuscarProducto,#txtDescProd").val("");
        $("#cmbMedida").val(1);
        $("#lblProducto").html("")
        $("#chkLav,#chkSec,#chkPla").prop("checked", "");
        DeshabilitarBotones();
        $("#tblRegProd").attr("data-edit", false);
        ProdVisible(false);
        estado = "";

        if (lstProd.length == 0) {
            $("#btnEliminar,#btnEditar").attr("disabled", true);
        } else {
            $("#btnEliminar,#btnEditar").attr("disabled", false);
        }

    }

    function DeshabilitarBotones() {
        $("#btnAgregar,#btnEditar,#btnEliminar,#btnCancelar").attr("disabled", "disabled");
    }

    function Eliminar() {
        var index = $("#tblRegProd tr.seleccionado").index();

        if (index == -1) {
            $.fn.Mensaje({ mensaje: "Seleccione un producto para eliminarlo", tamano: "sm" });
            return false;
        }
        else {
            lstProd.splice(index, 1);

            CrearTabla(lstProd);
            subTotal(lstProd);
        }
        LimpiarPro();
    }

    function LlenarDatos(d) {
        $("#lblProducto").html(d.cPrDesc);
        $("#txtPrec").val(number_format(d.nPrPrecU, 2));
        $("#txtCant").val(estado == "E" ? d.nCant : 1);
        $("#txtCant").attr("onkeypress", d.oPrMed.nom != "Kg" ? "return val_09(event)" : "return val_09D(event)");
        $("#txtImp").val(number_format(Math.round10($("#txtCant").val() * $("#txtPrec").val(), -1), 2));


        if (d.bProdO && estado == "E") {
            ProdVisible(true);
            var desc = d.cPrDesc;
            $("#txtDescProd").val(desc.substring(desc.indexOf("(") + 1, desc.indexOf(")")));
            $("#cmbMedida").val(d.oPrMed.id);
        }

        $("#chkLav").prop("checked", d.bPrSerLav);
        $("#chkPla").prop("checked", d.bPrSerPla);
        $("#chkSec").prop("checked", d.bPrSerSec);
    }

    $("#cntMedida").on("change", "#cmbMedida", function () {
        if ($(this).val() == 1) {
            $("#txtCant").attr("onkeypress", "return val_09D(event)");
        } else {
            $("#txtCant").val(number_format($("#txtCant").val(), 0));
            $("#txtCant").attr("onkeypress", "return val_09(event)");
        }
        $("#txtImp").val(number_format(Math.round10($("#txtCant").val() * $("#txtPrec").val(), -1), 2));

    });


    function CrearTabla(reg) {
        $("#cntRegProd").Tabla({
            tblId: "tblRegProd",
            cabecera: "Codígo,Descripción,Lavado,Secado,Planchado,Medida,Cantidad,Precio Unit,Importe",
            campos: "nPrId,cPrDesc,bPrSerLav,bPrSerSec,bPrSerPla,oPrMed.nom,nCant,nPrPrecU,nImp",
            cellLen: "100,300,100,100,100,100,100,100",
            tipoCampo: ",,,,,,D3,D,D",
            alinear: "C,L,C,C,C,C,C,R,R",
            scrollVertical: "Si",
            datos: reg
        });
    }


    //Grabar Nota Entrega

    function Grabar() {
        if (ValidaRegNotaEnt()) {

            if (!(typeof (lstProd) == "undefined" || lstProd == null)) {
                if (!(jQuery.isEmptyObject(lstProd))) {
                    for (i in lstProd) {
                        CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.nProdId", lstProd[i].nPrId);
                        CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].nDetCantidad", lstProd[i].nCant);
                        CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].nProdPrecioUnit", lstProd[i].nPrPrecU);
                        CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].nDetImporte", lstProd[i].nImp);

                        if (lstProd[i].bProdO) {
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.cProdDesc", lstProd[i].cPrDesc);
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.oProdMedida.cConstanteID", lstProd[i].oPrMed.id);
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.bProdSerLavado", lstProd[i].bPrSerLav);
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.bProdSerSecado", lstProd[i].bPrSerSec);
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.bProdSerPlanchado", lstProd[i].bPrSerPla);
                            CrearHidden("#cntHidden", "oNotEnt.ListaNotaEntProd[" + i + "].oProd.bProdOtros", lstProd[i].bProdO);
                        }
                    }
                }
            }

            var form = $("#frmNotaEntrega");
            valores = form.serializeArray();

            $.fn.Conexion({
                direccion: form.attr("action"),
                datos: valores,
                terminado: function (data, textStatus, jqXHR) {
                    if (data > 0) {
                        $("#txtCodNota").val(data);
                        $("#hdnNotaId").val(data);

                        $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación se realizó correctamente." });
                        SetEstadoPendiente();
                    } else if (data == -1) {
                        $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Usted no tiene ninguna caja aperturada." });
                    } else if (data == -2) {
                        $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                    }
                },
                bloqueo: true
            });
        }
    }

    function ValidaRegNotaEnt() {
        var bVal = true;

        if ($("#hdnPersId").val() == "") {
            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Es necesario asignar un cliente a la Nota de Entrega.", focusClose: "txtBuscarCliente" });
            bVal = false;
        } else if ($("#txtFechaEnt").val() == "") {
            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Es necesario indicar la fecha de recojo de las prendas.", focusClose: "txtFechaEnt" });
            bVal = false;
        } else if ($("#cmbUsuCaj").val() == "") {
            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Es necesario indicar el usuario que esta atiendo la Nota de Entrega.", focusClose: "cmbUsuCaj" });
            bVal = false;
        }

        return bVal
    }

    /*Cobrar Nota de Entrega*/

    $("#btnCobrarNota").bind("click", function () {
        LimpiarVtnCobroTotal();
        ListarNotaEntPend();
        $("#txtTotalC").val($("#txtTotal").val());
        $('#vntCobroCancelacion').modal('show');
        $("#hdnCliBoId").val($("#hdnPersId").val());
        $("#txtNombrePe").val($("#lblNom").html());
        $("#txtDOIPe").val($("#lblDOI").html());
    });

    $("#btnAceptarC").bind("click", function () {
        CobroTotal();
    });

    $("#btnCancelarC").bind("click", function () {
        LimpiarVtnCobroTotal();
    });

    function LimpiarVtnCobroTotal() {
        $("#cmbTipoComp").val(1);
        $("#frmCobroTotal").validator('destroy');
        $('#frmCobroTotal')[0].reset();
        $("#hdnCliBoId").val("");
        $("#msg").html("");
    }

    function CobroTotal() {
        var form = $("#frmCobroTotal");

        form.validator();

        var validator = form.data("bs.validator");
        validator.validate();

        if (!validator.hasErrors()) {

            var nNotaId = $("#hdnNotaId").val();
            var nPersId = $("#hdnCliBoId").val();
            var nTipoC = $("#cmbTipoComp").val();
            var nEfeCo = $("#txtEfectivoC").val();
            var nCambCo = $("#txtCambioC").val();


            if (nCambCo <= 0) {
                $.fn.Conexion({
                    direccion: '/NotaEntrega/RealizarCobroServicio',
                    datos: { "nNotaEntId": nNotaId, "nPersId": nPersId, "nTipoC": nTipoC, "nEfecCo": nEfeCo, "nCambioCo": nCambCo },
                    terminado: function (data, textStatus, jqXHR) {
                        if (data > 0) {
                            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación se realizó correctamente." });
                            SetEstadoPagado();
                        } else if (data == -1) {
                            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Usted no tiene ninguna caja aperturada." });
                        } else if (data == -2) {
                            $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                        }
                        $('#vntCobroCancelacion').modal('hide');
                        LimpiarVtnCobroTotal();
                    },
                    bloqueo: false
                });
            } else {
                advertencia("#msg", "El monto del efectivo es menor al monto total.");
            }
        } else {
            advertencia("#msg", "Ingrese el monto del efectivo.");
        }
    }

    $("#txtEfectivoC").keyup(function () { $("#txtCambioC").val(number_format(Math.round10($("#txtTotalC").val() - $("#txtEfectivoC").val(), -1), 2)) });

    /*END - Cobrar Nota de Entrega*/

    /*Confirmar Entrega */

    $("#btnConfirmarEntrega").bind("click", function () {
        $.fn.Mensaje({ titulo: "Atención", tipo: "SiNo", mensaje: "¿Desea confirmar la entrega de las prendas?", funcionAceptar: ConfirmarEntrega });
    });

    function ConfirmarEntrega() {
        var nNotaId = $("#hdnNotaId").val();

        $.fn.Conexion({
            direccion: '/NotaEntrega/RealizarConfirmacionEntrega',
            datos: { "nNotaEntId": nNotaId },
            terminado: function (data, textStatus, jqXHR) {
                if (data > 0) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación se realizó correctamente." });
                    SetEstadoEntregado();
                } else if (data == -1) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Usted no tiene ninguna caja aperturada." });
                } else if (data == -2) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                }
            },
            bloqueo: false
        });
    }

    /*End Confirmar Entrega*/

    /*Buscar datos persona Boleta*/

    var persSelec = {}

    function BuscarCliBoleta(valor) {
        var aceptar = function (d) {
            persSelec = d;
            $("#hdnCliBoId").val(d.id);
            $("#txtNombrePe").val(d.nom);
            $("#txtDOIPe").val(d.doi);
            $("#txtDirecc").val(d.direc);
            $('#vntBuscaPersona').modal('hide');
        };

        var cancelar = function () {
            //$("#btnCancelar").click();
        }
        $.fn.BuscarPersona({
            funcionAceptar: aceptar,
            funcionCancelar: cancelar,
            valor: valor
        });
    }

    $("#btnBuscarCliBo").bind("click", function () {
        BuscarCliBoleta($("#txtBuscarCliBo").val());
    });

    $("#txtBuscarCliBo").bind("keyup", function (e) {
        if (e.which == 13) { BuscarCliBoleta($(this).val()); };
    });

    /*END  Buscar datos persona Boleta*/



    /*Anular Nota*/

    $("#btnAnularNota").bind("click", function () {
        $.fn.Mensaje({ titulo: "Atención", tipo: "SiNo", mensaje: "¿Está seguro de que desea Anular esta Nota de Entrega?", funcionAceptar: AnularNota });
    });

    function AnularNota() {
        var nNotaId = $("#hdnNotaId").val();

        $.fn.Conexion({
            direccion: '/NotaEntrega/RealizarAnularNota',
            datos: { "nNotaEntId": nNotaId },
            terminado: function (data, textStatus, jqXHR) {
                if (data >= 1) {
                    $.fn.Mensaje({ titulo: "Atención", tipo: "SiNo", mensaje: "Se realizó el proceso de Anulación con exito. ¿Desea mantener los datos actuales?", funcionAceptar: ConservarDatos, funcionCancelar: Limpiar });
                    ListarNotaEntrega(1, 10);
                } else if (data == -1) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La Nota de Entrega ya se encuentra anulada." });
                } else if (data == -2) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Usted no tiene ninguna caja aperturada." });
                } else if (data == -3) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                }
            },
            bloqueo: false
        });
    }

    function ConservarDatos() {
        $("input[type=hidden],#txtCodNota").val("");
        RestablecerElem();
    }

    $("#btnAnularComp").bind("click", function () {
        $.fn.Mensaje({ titulo: "Atención", tipo: "SiNo", mensaje: "¿Está seguro de que desea Anular el Comprobante de Pago?", funcionAceptar: AnularComprob });
    });

    function AnularComprob() {
        var nNotaId = $("#hdnNotaId").val();

        $.fn.Conexion({
            direccion: '/NotaEntrega/RealizarAnularComprobante',
            datos: { "nNotaEntId": nNotaId },
            terminado: function (data, textStatus, jqXHR) {
                if (data >= 1) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Se realizó la anulación del Comprobante de Pago correctamente." });
                    SetEstadoPendiente();
                } else if (data == -1) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "El Comprobante de Pago no existe o ya se encuentra anulado." });
                } else if (data == -2) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "Usted no tiene ninguna caja aperturada." });
                } else if (data == -3) {
                    $.fn.Mensaje({ titulo: "Mensaje", mensaje: "La operación no se realizó correctamente." });
                }
            },
            bloqueo: false
        });
    }


    /*END - Anular Nota*/

    function Aceptar() {
        Limpiar();
        vista("#target1");
        ListarProducto();
    }

    $("#btnCanEnt").bind("click", function () {
        Limpiar();
        vista("#target1");
    });

    function Limpiar() {
        $('#frmNotaEntrega')[0].reset();
        lstProd = [];
        $("input[type=hidden],#txtCodNota").val("");
        $("#lblNom,#lblDOI,#lblTel,#tblRegProd tbody").html("");
        RestablecerElem();
        DeshabilitarBotones();
    }

    function RestablecerElem() {
        $("#target2").find("input,textarea,button").attr("disabled", false);
        $("#txtCodNota,#txtPrec,#txtImp,#btnCobrarNota,#btnConfirmarEntrega,#btnAnularNota,#btnAnularComp").attr("disabled", true);
    }


    //Prueba Nota Pendiente

    function ListarNotaEntPend() {

        var nNotaId = $("#hdnNotaId").val();
        var bMult = $("#chkMultiple").is(':checked');

        $.fn.Conexion({
            direccion: '/NotaEntrega/BuscarNotaEntPend',
            datos: { "nNotaId": nNotaId, "bMult": bMult },
            terminado: function (data) {
                var d = JSON.parse(data);

                $("#cntListaNotaEntPend").Tabla({
                    tblId: "tblNotaEntPend",
                    textSearchId: "txtBuscarNota",
                    cabecera: "Nota,Cliente,DOI,Fecha Registro,P. de Pago",
                    campos: "bCheck,nNotaEntId,oPers.nom,oPers.doi,dFecReg,nNotaMonTot",
                    scrollVertical: "Si",
                    tipoCampo: "C,,,,F,D,",
                    alinear: "C,C,C,C,C,C",
                    cellLen: "50,70,364,0,150,150,60",
                    cantRegVertical: 8,
                    check: true,
                    checkHead: true,
                    search: true,
                    dblClick: true,
                    checkEvent: function (fila,e) {
                        var nMonto = fila.find("td").eq(5).html();
                        var nMontoAnt = $("#txtTotalC").val()
                        
                        
                        if ($(e).is(':checked')) {
                            $("#txtTotalC").val(number_format((nMontoAnt * 1) + (nMonto * 1), 2));
                        } else {
                            $("#txtTotalC").val(number_format((nMontoAnt * 1) - (nMonto * 1), 2));
                        }

                        //number_format( , 2)


                        //$("#hdnEstado").val("E");
                        //$('input.target')[0].click();

                        //$.fn.Conexion({
                        //    direccion: '/NotaEntrega/CargoDatosNotaEntrega',
                        //    datos: { "nNotaId": nNotaId },
                        //    terminado: function (data, textStatus, jqXHR) {
                        //        var oNota = JSON.parse(data);
                        //        $("#hdnPersId").val(oNota.oPers.id);
                        //        $("#hdnNotaEst").val(oNota.oNotaEst.id);
                        //        $("#lblNom").html(oNota.oPers.nom);
                        //        $("#lblDOI").html(oNota.oPers.doi);
                        //        $("#lblTel").html(oNota.oPers.tel1);
                        //        $("#txtCodNota").val(oNota.nNotaEntId);
                        //        $("#hdnNotaId").val(oNota.nNotaEntId);
                        //        $("#txtCom").val(oNota.cNotaCom);
                        //        $("#cmbUsuCaj").val(oNota.cNotaUsuAt);
                        //        $("#txtDescuento").val(number_format(oNota.nNotaDes, 2));
                        //        $("#txtAnticipo").val(number_format(oNota.nNotaAnt, 2));
                        //        $('#txtFechaEnt').val(moment(oNota.dFecEnt).format("DD/MM/YYYY hh:mm A"));

                        //        var lst = oNota.lstNotEntProd;
                        //        lstProd = [];

                        //        for (i in lst) {

                        //            var obj = {
                        //                nPrId: lst[i].oProd.nPrId,
                        //                cPrDesc: lst[i].oProd.cPrDesc,
                        //                bPrSerLav: lst[i].oProd.bPrSerLav,
                        //                bPrSerPla: lst[i].oProd.bPrSerPla,
                        //                bPrSerSec: lst[i].oProd.bPrSerSec,
                        //                bProdO: lst[i].oProd.bProdO,
                        //                oPrMed: { id: lst[i].oProd.oPrMed.id, nom: lst[i].oProd.oPrMed.nom },
                        //                nCant: lst[i].nDetCant,
                        //                nPrPrecU: lst[i].nPrPrecU,
                        //                nImp: lst[i].nDetImp
                        //            };
                        //            lstProd = lstProd.concat([obj]);
                        //        }

                        //        lstProd = lstProd;

                        //        CrearTabla(lstProd);
                        //        subTotal(lstProd);


                        //        if (oNota.oNotaEst.id == 1) {
                        //            SetEstadoPendiente();
                        //        } else if (oNota.oNotaEst.id == 2) {
                        //            SetEstadoPagado();
                        //        } else if (oNota.oNotaEst.id == 3) {
                        //            SetEstadoEntregado();
                        //        } else if (oNota.oNotaEst.id == 4) {
                        //            SetEstadoAnulado();
                        //        }
                        //    },
                        //    bloqueo: false
                        //});
                    },
                    datos: d
                });

                if (!bMult) {
                    Bloqueo();
                } else {
                    $("#tblNotaEntPend").find("tr input:checked").attr("disabled", true);
                }
                
            }
        });
    }

    $("#btnNuevoCli").bind("click", function () {
        $('#txtBuscarCliBo,#btnNuevoCli').attr("disabled", true);
        $('#txtNombrePe,#txtDirecc,#txtDOIPe').attr("disabled", false).val("");
        $("#txtNombrePe").focus()

    });

    function Bloqueo() {
        $("#tblNotaEntPend tr input").attr("disabled", true);
    }

    $("#chkMultiple").on('change', function () {
        $('#txtBuscarNota').val("");

        if ($(this).is(':checked')) {
            $('#txtBuscarNota').attr("disabled", false);
            ListarNotaEntPend();

        } else {
            // Hacer algo si el checkbox ha sido deseleccionado
            ListarNotaEntPend();
            $('#txtBuscarNota').attr("disabled", true);
            //Bloqueo();
        }
    });


</script>
